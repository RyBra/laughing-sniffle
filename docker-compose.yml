services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3

  agent-gateway:
    build:
      context: .
      dockerfile: services/agent_gateway/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TASK_QUEUE_NAME: inventory_tasks
      TASK_QUEUE_MAXSIZE: "100"
      PUT_TIMEOUT_SECONDS: "2.0"
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: "50051"
      LOG_DIR: /app/logs/agent-gateway
      LOG_LEVEL: info
    volumes:
      - ./:/workspace:ro
      - ./logs:/app/logs
    ports:
      - "50051:50051"
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import grpc; from proto import agent_pb2, agent_pb2_grpc; ch=grpc.insecure_channel('localhost:50051'); stub=agent_pb2_grpc.AgentGatewayStub(ch); stub.Health(agent_pb2.HealthRequest())\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  result-writer:
    build:
      context: .
      dockerfile: services/result_writer/Dockerfile
    depends_on:
      redis:
        condition: service_healthy
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      RESULT_QUEUE_NAME: inventory_results
      PAYLOAD_PATH: /data/payload.json
      LOG_DIR: /app/logs/result-writer
      LOG_LEVEL: info
    volumes:
      - ./data:/data
      - ./logs:/app/logs
